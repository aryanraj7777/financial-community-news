<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Pulse Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        .card {
            backdrop-filter: blur(10px);
            background-color: rgba(31, 41, 55, 0.7); /* slightly transparent dark card */
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* Custom scrollbar for better look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4B5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1F2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold tracking-tight text-teal-400">
                Financial Pulse
            </h1>
            <p class="mt-2 text-gray-400 text-xl font-light">Real-Time Market Intelligence</p>
        </header>

        <!-- Input and Control Panel -->
        <div class="card p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-200 flex items-center">
                <i data-lucide="zap" class="w-6 h-6 mr-3 text-yellow-400"></i> Market Focus
            </h2>
            <div class="flex flex-col md:flex-row gap-4">
                <input
                    type="text"
                    id="topicInput"
                    placeholder="Enter stock, sector, or market topic (e.g., 'Google earnings' or 'Crude Oil futures')"
                    class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:ring-teal-500 focus:border-teal-500 transition duration-300"
                    value="Latest S&P 500 performance and tech stock news"
                />
                <button
                    id="fetchButton"
                    onclick="fetchMarketNews()"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg shadow-teal-500/50 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                    Fetch Live News
                </button>
            </div>
        </div>

        <!-- News Result Panel -->
        <div id="resultsPanel" class="card p-6 rounded-xl shadow-2xl transition duration-500 min-h-[300px]">
            <h2 class="text-2xl font-semibold mb-4 text-gray-200 flex items-center">
                <i data-lucide="newspaper" class="w-6 h-6 mr-3 text-blue-400"></i> Latest Analysis
            </h2>

            <!-- Loading Spinner -->
            <div id="loading" class="hidden flex flex-col items-center justify-center h-full py-16">
                <div class="pulse-animation w-10 h-10 border-4 border-t-4 border-t-teal-500 border-gray-600 rounded-full animate-spin"></div>
                <p class="mt-4 text-teal-400 font-medium">Analyzing market data...</p>
            </div>

            <!-- Content Display -->
            <div id="newsContent">
                <p class="text-gray-400 italic">Enter a market topic above and click 'Fetch Live News' to get a real-time summary from top financial news sources.</p>
            </div>

            <!-- Sources/Citations -->
            <div id="sourcesArea" class="mt-6 pt-4 border-t border-gray-700 hidden">
                <h3 class="text-lg font-medium mb-2 text-gray-300">Sources (Grounded Content)</h3>
                <div id="sourcesList" class="text-sm space-y-1">
                    <!-- Sources will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Import necessary Firebase functions
        // Although this app doesn't use Firestore, keeping the structure standard
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Global Firebase & Auth Setup (MANDATORY TEMPLATE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let auth, db, app;

        // Initialize Firebase and Auth
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);

            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).then(userCredential => {
                    console.log("Signed in with custom token:", userCredential.user.uid);
                }).catch(error => {
                    console.error("Error signing in with custom token:", error);
                });
            } else {
                signInAnonymously(auth).then(userCredential => {
                    console.log("Signed in anonymously:", userCredential.user.uid);
                }).catch(error => {
                    console.error("Error signing in anonymously:", error);
                });
            }
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
        // --- END MANDATORY TEMPLATE ---
        
        // Ensure Lucide icons are rendered
        window.onload = () => {
            lucide.createIcons();
        };

        const fetchButton = document.getElementById('fetchButton');
        const topicInput = document.getElementById('topicInput');
        const loading = document.getElementById('loading');
        const newsContent = document.getElementById('newsContent');
        const sourcesArea = document.getElementById('sourcesArea');
        const sourcesList = document.getElementById('sourcesList');

        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = ""; // Canvas will provide the key at runtime

        /**
         * Simple utility to introduce exponential backoff for API retries.
         */
        async function makeApiCallWithBackoff(payload, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); // 1s, 2s, 4s + jitter
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API call failed with status ${response.status}: ${errorBody.error?.message || response.statusText}`);
                    }

                    return response.json();

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error; // Re-throw final error
                }
            }
        }

        window.fetchMarketNews = async function() {
            const topic = topicInput.value.trim();
            if (!topic) {
                newsContent.innerHTML = '<p class="text-red-400 font-bold">Please enter a market topic to analyze.</p>';
                sourcesArea.classList.add('hidden');
                return;
            }

            // UI state: Disable button, show loading
            fetchButton.disabled = true;
            loading.classList.remove('hidden');
            newsContent.innerHTML = '';
            sourcesArea.classList.add('hidden');

            const systemPrompt = `You are a professional financial news analyst for a top-tier trading platform. Summarize the current market trends, major stock movements, and most critical recent trading news (in a maximum of three concise paragraphs) related to the user's query: "${topic}". Maintain an objective, informative, and urgent tone. Do not use conversational phrasing.`;
            
            const payload = {
                contents: [{ parts: [{ text: topic }] }],
                tools: [{ "google_search": {} }], // Enable Google Search grounding
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await makeApiCallWithBackoff(payload);
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    // Format text by replacing newlines with paragraphs
                    const formattedText = text.split('\n').filter(p => p.trim() !== '').map(p => 
                        `<p class="mb-4 leading-relaxed">${p.trim()}</p>`
                    ).join('');

                    newsContent.innerHTML = `<div class="text-gray-200">${formattedText}</div>`;

                    // Handle Sources
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    if (sources.length > 0) {
                        sourcesList.innerHTML = sources.map((source, index) => 
                            `<div class="flex items-start text-sm"><i data-lucide="link" class="w-4 h-4 text-teal-400 mr-2 mt-1 flex-shrink-0"></i><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-teal-400 transition underline truncate">${source.title}</a></div>`
                        ).join('');
                        sourcesArea.classList.remove('hidden');
                        lucide.createIcons(); // Re-render icons after adding new HTML
                    } else {
                        sourcesList.innerHTML = '<p class="text-gray-500 italic">No direct sources were found for this summary.</p>';
                        sourcesArea.classList.remove('hidden');
                    }

                } else {
                    newsContent.innerHTML = '<p class="text-red-400 font-bold">Analysis failed. Please try a different topic or check the console for API errors.</p>';
                    sourcesArea.classList.add('hidden');
                }

            } catch (error) {
                console.error("Global fetch error:", error);
                newsContent.innerHTML = `<p class="text-red-400 font-bold">An error occurred while fetching the data. ${error.message}</p>`;
                sourcesArea.classList.add('hidden');
            } finally {
                // UI state: Enable button, hide loading
                loading.classList.add('hidden');
                fetchButton.disabled = false;
            }
        }
    </script>
</body>
</html>
